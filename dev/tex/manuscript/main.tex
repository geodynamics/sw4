\documentclass[a4paper]{article}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{tikz}
\usetikzlibrary{arrows}
\usepackage{booktabs}
\usepackage{threeparttable}
\usepackage{tikz}
\usetikzlibrary{arrows.meta}
\usepackage{pgfplots}
\usepackage{subcaption}
\usepackage[toc,page]{appendix}
\usepackage{bm}
\usepackage{amsfonts}
\usepackage{algorithm,algpseudocode}

\makeatletter
\newenvironment{breakablealgorithm}
{% \begin{breakablealgorithm}
	\begin{center}
		\refstepcounter{algorithm}% New algorithm
		\hrule height.8pt depth0pt \kern2pt% \@fs@pre for \@fs@ruled 
		\renewcommand{\caption}[2][\relax]{% Make a new \caption
			{\raggedright\textbf{\ALG@name~\thealgorithm} ##2\par}%
			\ifx\relax##1\relax % #1 is \relax
			\addcontentsline{loa}{algorithm}{\protect\numberline{\thealgorithm}##2}%
			\else % #1 is not \relax
			\addcontentsline{loa}{algorithm}{\protect\numberline{\thealgorithm}##1}%
			\fi
			\kern2pt\hrule\kern2pt
		}
	}{% \end{breakablealgorithm}
		\kern2pt\hrule\relax% \@fs@post for \@fs@ruled 
	\end{center}
}
\makeatother

\newcommand{\wt}{\widetilde}


\title{Fourth order summation-by-parts finite difference methods for  3-D elastic wave propagation in curvilinear coordinates with mesh refinement interfaces}

\date{\today}
\author{ Lu Zhang \and Siyang Wang \and N. Anders Petersson}
\begin{document}
\maketitle

\begin{abstract}
We analyze
\end{abstract}

\section{Introduction}

\section{The isotropic elastic wave equation }
We consider the time dependent isotropic elastic wave equation in three dimensional domain for simple Cartesian domain and the curvilinear domian.
\subsection{The Cartesian coordinates}
The problem is defined on the domain ${\bf x}\in\Omega = [0,a^{(1)}]\times[0,a^{(2)}]\times[0,a^{(3)}]$ with ${\bf x} = (x_1,x_2,x_3)^T$ are Cartesian coordinates. Denote ${\bf u} = (u_1,u_2,u_3)^T$ to be the three dimensional displacement vector in Cartesian coordinates, then the elastic wave equation takes the form,
\begin{align*}
    \rho\frac{\partial^2{\bf u}}{\partial^2 t} &= \nabla\cdot\mathcal{T} + {\bf F}, \ \ \ {\bf x}\in\Omega,\ \ \ t\geq 0,\\
    \nabla\cdot\mathcal{T} &:= {\bf Lu},
\end{align*}
provided with appropriate initial and boundary conditions. Here, $\rho$ is density, $\mathcal{T}$ is the stress tensor and ${\bf F}$ is the force function. The spatial operator ${\bf L}$ is called $3\times3$ symmetric Kelvin-Christoffel differential operator matrix, specifically,
\begin{equation*}
    {\bf L u} = \partial_1(A_1\nabla{\bf u}) + \partial_2(A_2\nabla{\bf u}) + \partial_3(A_3\nabla{\bf u}),
\end{equation*}
with
\begin{align*}
A_1\nabla{\bf u} &:= M_{11}\partial_1{\bf u} + M_{12}\partial_2{\bf u} + M_{13}\partial_3{\bf u}, \\
A_2\nabla{\bf u} &:= M_{21}\partial_1{\bf u} + M_{22}\partial_2{\bf u} + M_{23}\partial_3{\bf u}, \\
A_3\nabla{\bf u} &:= M_{31}\partial_1{\bf u} + M_{32}\partial_2{\bf u} + M_{33}\partial_3{\bf u},
\end{align*}
where $M_{ij}, i,j = 1,2,3$ are defined by
\begin{equation*}
M_{ij} = P^T_iCP_j.
\end{equation*}
Here, $C$ is symmetric and positive definite, we refer to Appendix ? for the definitions of matrices $C$ and $P_i, i = 1,2,3$. Especially, for the isotropic elastic wave equation, we have
\[ M_{11} = \left(\begin{array}{ccc}
2\mu+\lambda & 0 & 0\\
0 & \mu & 0\\
0 & 0 & \mu\end{array}\right), M_{12} = \left(\begin{array}{ccc}
0 & \lambda & 0\\
\mu & 0 & 0\\
0 & 0 & 0\end{array}\right), M_{13} = \left(\begin{array}{ccc}
0 & 0 & \lambda\\
0 & 0 & 0\\
\mu & 0 & 0\end{array}\right),\]
\[ M_{21} =(M_{12})^T, M_{22} = \left(\begin{array}{ccc}
\mu & 0 & 0\\
0 & 2\mu+\lambda & 0\\
0 & 0 & \mu\end{array}\right), M_{23} = \left(\begin{array}{ccc}
0 & 0 & 0\\
0 & 0 & \lambda\\
0 & \mu & 0\end{array}\right),\]
\[ M_{31} = (M_{13})^T, \ \ \ \ \ M_{32} =(M_{23})^T, \ \ \ \ \ M_{33} = \left(\begin{array}{ccc}
\mu & 0 & \lambda\\
0 & \mu & 0\\
0 & 0 & 2\mu+\lambda\end{array}\right),\]
Here, $\lambda$ and $\mu$ are the first and second Lame parameters respectively, which are determined by the properties of the materials.

Denote the outward unit normal ${\bf n}_i = (n_i^{(1)},n_i^{(2)},n_i^{(3)})$ for the boundaries $x^{(i)} = 0, a^{(i)}, i = 1,2,3$. For example, ${\bf n}_1 = (\pm 1, 0,0)$ for the boundaries $x^{(1)} = 1$ or $x^{(1)} = 0$, then we have the boundary traction data 
\begin{equation*}
{\bf n}_i\cdot\mathcal{T} = n^{(1)}_iA_1\nabla{\bf u} + n^{(2)}_iA_2\nabla{\bf u} + n^{(3)}_iA_3\nabla{\bf u},\ \ i = 1,2,3. 
\end{equation*}
A homogeneous Dirichlet boundary condition corresponds to ${\bf u} = {\bf 0}$ and a free surface boundary condtion is ${\bf n}_i\cdot\mathcal{T}  = {\bf 0}, i = 1,2,3$.

It is known that the elastic wave equation with the homogeneous Dirichelet boundary conidtion or free surface boundary condition with a Cartesian domain is a well-posed problem and the total energy of the solution is conserved if the external force function ${\bf F} = 0$, we refer to \cite{?} for a detailed analysis.

\subsection{Generalization to curvilinear coordinates}
%Present the transformed equation. Notation is important. We can write a few formulas first, and discuss if it is good notation. Maybe we shall follow notations from one of Anders' papers?

In this section, we consider a curvilinear domain. Assume there is a one-to-one mapping ${\bf x} = {\bf x}({\bf r}) : [0,1]^3 \rightarrow \Omega \in \mathbb{R}^3$ with ${\bf x}({\bf r}) = (x^{(1)}({\bf r}),x^{(2)}({\bf r}),x^{(3)}({\bf r}))^T, {\bf r} = (r^{(1)},r^{(2)},r^{(3)})^T, 0\leq r^{(i)}\leq1, i = 1,2,3$.

We define the derivative of the forward mapping to be 
\begin{equation}\label{elastic_eq_carte}
{\bf a}_k := \bar{\partial}_k{\bf x} = \left(\frac{\partial x^{(1)}}{\partial r^{(k)}},\frac{\partial x^{(2)}}{\partial r^{(k)}},\frac{\partial x^{(3)}}{\partial r^{(k)}}\right)^T,
\end{equation}
for $k = 1,2,3$ and the backward mapping to be
\begin{equation*}
{\bf a}^k := \nabla r^{(k)} = \left(\frac{\partial r^{(k)}}{\partial x^{(1)}},\frac{\partial r^{(k)}}{\partial x^{(2)}},\frac{\partial r^{(k)}}{\partial x^{(3)}}\right)^T := (\xi_{1k},\xi_{2k},\xi_{3k})^T,
\end{equation*}
for $k = 1,2,3$. It is known that the backward mapping can be expressed by the forward mapping \cite{?}, 
\begin{equation*}
{\bf a}^i = \frac{1}{J}({\bf a}_j\times{\bf a}_k), \ \ \ (i,j,k) \ \text{cycle},
\end{equation*}
here, $J$ is the Jacobian of the forward mapping $J = \text{det}({\bf a}_1, {\bf a}_2, {\bf a}_3)$ and the mapping is assumed to be non-singular with $0<J<\infty$.

After applying the forward and backward mapping, reader can refer to \cite{?} for details, the elastic wave equation (\ref{elastic_eq_carte}) can be written as
\begin{equation}\label{elastic_eq_curvi}
\rho\frac{\partial^2 {\bf u}}{\partial t^2} = \frac{1}{J}\left[\tilde{\partial }_1(\tilde{A}_1\tilde{\nabla}{\bf u}) + \tilde{\partial }_2(\tilde{A}_2\tilde{\nabla}{\bf u}) +\tilde{\partial }_3(\tilde{A}_3\tilde{\nabla}{\bf u}) \right] + {\bf F},
\end{equation}
where
\begin{align*}
	\bar{A}_1\bar{\nabla}{\bf u} &:= N_{11}\bar{\partial}_1{\bf u} + N_{12}\bar{\partial}_2{\bf u} + N_{13}\bar{\partial}_3{\bf u}, \\
	\bar{A}_2\bar{\nabla}{\bf u} &:= N_{21}\bar{\partial}_1{\bf u} + N_{22}\bar{\partial}_2{\bf u} + N_{23}\bar{\partial}_3{\bf u}, \\
	\bar{A}_3\bar{\nabla}{\bf u} &:= N_{31}\bar{\partial}_1{\bf u} + N_{32}\bar{\partial}_2{\bf u} + N_{33}\bar{\partial}_3{\bf u},
\end{align*}
here, 
\begin{equation}\label{definition_Nij}
N_{ij} = J\bar{P}_i^TC\bar{P}_j \ \ \text{with} \ \ \bar{P}_i = \sum_{j=1}^3\xi_{ji}P_j.
\end{equation}
The matrices $C$ and $P_i, i = 1,2,3$ can be found in Appendix ?. 

The transformation of homogeneous Dirichlet boundary condiiton to curvilinear coordinates is straightfroward, ${\bf u}({\bf x}) = {\bf u}(\bf r)$. To transfer the free surface boundary condition to curvilinear coordinates, we firstly write the unit outside normal to be the function of metric derivatives, for example, along the boundary $r^{(3)} = 1$ or $r^{(3)} = 0$,
\begin{equation}\label{definition_bdry3_curvi}
{\bf n}_3 := (n^{(1)}_3,n^{(2)}_3,n^{(3)}_3)^T = \pm \frac{\nabla r^{(3)}}{\left|\nabla r^{(3)}\right|} = \frac{\pm 1}{\sqrt{((\xi_{13})^2+(\xi_{23})^2+(\xi_{33})^2)}}\left(\xi_{13},\xi_{23},\xi_{33}\right)^T,
\end{equation}
here, $'+'$ corresponds to $r^{(3)} = 1$ and $'-'$ corresponds to $r^{(3)} = 0$. Then after some straightforward calculation, the traction free boundary condition can be written as
\begin{equation}\label{bdry3_curvi}
\mathcal{T}\cdot{\bf n}_3 = \frac{\pm 1}{J\left|\nabla r^{(3)}\right|}\bar{A}_3\bar{\nabla}{\bf u}, \ \ \ r^{(3)} = 0, 1.
\end{equation}
Similarly, we can derive the traction free boundary condition along $r^{(1)} = 0,1$ and $r^{(2)} = 0,1$ as
\begin{equation}\label{bdry1_curvi}
\mathcal{T}\cdot{\bf n}_1 = \frac{\pm 1}{J\left|\nabla r^{(1)}\right|}\bar{A}_1\bar{\nabla}{\bf u}, \ \ \ r^{(1)} = 0, 1,
\end{equation}
\begin{equation}\label{bdry2_curvi}
\mathcal{T}\cdot{\bf n}_2 = \frac{\pm 1}{J\left|\nabla r^{(2)}\right|}\bar{A}_2\bar{\nabla}{\bf u}, \ \ \ r^{(2)} = 0, 1,
\end{equation} 
respectively. Here, the ${\bf n}_1$ and ${\bf n}_2$ have a similar definition as ${\bf n}_3$ in (\ref{definition_bdry3_curvi}).

\subsubsection{Energy estimate}

From the definition of matrcies $N_{ij}$, we can easily verify that $N_{11}, N_{22}, N_{33}$ are positive definite and $N_{ij} = N_{jk}^T$. In the curvilinear coordinates, we define the $L^2$ scalar product of the two real vector-valued functions ${\bf u}({\bf r})\in\mathbb{R}^3\rightarrow \mathbb{R}^3$ and ${\bf v}(\bf r)\in\mathbb{R}^3\rightarrow \mathbb{R}^3$ by
\begin{equation*}
({\bf u},{\bf v})_2 = \int_{{\bf r}\in[0,1]^3} \left(\sum_{l=1}^q u^{l}v^{l}\right)Jdr^{(1)}dr^{(2)}dr^{(3)}.
\end{equation*}
To analyze the energy estimate of the solution of an elastic wave equation in the curvilinear domain, we multiply the equation (\ref{elastic_eq_curvi}) by $J{\bf u}_t$ and integrate over the parameter space $[0,1]^3$,
\begin{align}\label{time_deri_curvi}
({\bf u}_t,\rho {\bf u}_{tt})_2 &= \left({\bf u}_t,\frac{1}{J}\bar{\partial}_1(\bar{A}_1\bar{\nabla}{\bf u})\right)_2+ \left({\bf u}_t,\frac{1}{J}\bar{\partial}_2(\bar{A}_2\bar{\nabla}{\bf u})\right)_2+ \left({\bf u}_t,\frac{1}{J}\bar{\partial}_3(\bar{A}_3\bar{\nabla}{\bf u})\right)_2+({\bf u}_t, {\bf F})_2\nonumber\\
&:= -S({\bf u}_t,{\bf u}) + B({\bf u}_t,{\bf u}) + ({\bf u}_t,{\bf F})_2,
\end{align}
where the term $S$ represents the interior terms after integration by parts,
\begin{multline*}
S({\bf u}_t,{\bf u}) = \int_{{\bf r}\in[0,1]^3} (\bar{\partial}_1 {\bf u}_t)^T ({\bar A}_1\bar{\nabla}{\bf u}) + (\bar{\partial}_2 {\bf u}_t)^T ({\bar A}_2\bar{\nabla}{\bf u}) + (\bar{\partial}_3 {\bf u}_t)^T ({\bar A}_3\bar{\nabla}{\bf u})\ dr^{(1)}dr^{(2)}dr^{(3)}\\
 = \int_{{\bf r}\in[0,1]^3} (\bar{\partial}_1 {\bf u}_t)^T (N_{11}\bar{\partial}_1{\bf u} +N_{12}\bar{\partial}_2{\bf u}+ N_{13}\bar{\partial}_3{\bf u}) + (\bar{\partial}_2 {\bf u}_t)^T (N_{21}\bar{\partial}_1{\bf u} +N_{22}\bar{\partial}_2{\bf u}+ N_{23}\bar{\partial}_3{\bf u}) \\
 +(\bar{\partial}_3 {\bf u}_t)^T (N_{31}\bar{\partial}_1{\bf u} +N_{32}\bar{\partial}_2{\bf u}+ N_{33}\bar{\partial}_3{\bf u})\ dr^{(1)}dr^{(2)}dr^{(3)}\\
 = \sum_{i = 1}^3\sum_{j=1}^3  \int_{{\bf r}\in[0,1]^3} (\bar{\partial}_i {\bf u}_t)^T(N_{ij}\bar{\partial}_j {\bf u})\ dr^{(1)}dr^{(2)}dr^{(3)}.
\end{multline*}
Recall the definition of $N_{ij}, i,j = 1,2,3$ in (\ref{definition_Nij}), we have
\begin{multline*}
S({\bf u}_t,{\bf u}) = \sum_{i=1}^3\sum_{j=1}^3 \int_{{\bf r}\in[0,1]^3} (\bar{\partial}_i {\bf u}_t)^T(J\bar{P}_i^TC\bar{P}_j\bar{\partial}_j {\bf u})\ dr^{(1)}dr^{(2)}dr^{(3)} \\
= \sum_{i=1}^3\sum_{j=1}^3 \int_{{\bf r}\in[0,1]^3} (\bar{P}_i\bar{\partial}_i {\bf u}_t)^TC(\bar{P}_j\bar{\partial}_j {\bf u}) J\ dr^{(1)}dr^{(2)}dr^{(3)}.
\end{multline*}
Since $C$ is a symmetric and positive definite matrix and $J > 0$, we have 
\begin{equation*}
S({\bf u}_t,{\bf u}) = S({\bf u},{\bf u}_t) \ \ \  \text{and} \ \ \ S({\bf u},{\bf u}) \geq 0.
\end{equation*}
The term $B$ that contains the boundary intergrals satisfies
\begin{multline}\label{bdry_integral_ref}
B({\bf u}_t,{\bf u}) = \int_{r^{(1)} = 0}^{r^{(1)} = 1} \int_{r^{(2)} = 0}^{r^{(2)} = 1}  \left[{\bf u}_t^T\bar{A}_3\bar{\nabla} {\bf u}\right]_{r^{(3)}=0}^{r^{(3)}=1} \ dr^{(1)}dr^{(2)}\\
+ \int_{r^{(2)} = 0}^{r^{(2)} = 1} \int_{r^{(3)} = 0}^{r^{(3)} = 1}  \left[{\bf u}_t^T\bar{A}_1\bar{\nabla} {\bf u}\right]_{r^{(1)}=0}^{r^{(1)}=1}\ dr^{(2)}dr^{(3)} +\int_{r^{(1)} = 0}^{r^{(1)} = 1} \int_{r^{(3)} = 0}^{r^{(3)} = 1}  \left[{\bf u}_t^T\bar{A}_2\bar{\nabla} {\bf u}\right]_{r^{(2)}=0}^{r^{(2)}=1} \ dr^{(1)}dr^{(3)},
\end{multline}
Compare the terms (\ref{bdry3_curvi}) to (\ref{bdry2_curvi}) with (\ref{bdry_integral_ref}), we note that the intergral terms in (\ref{bdry_integral_ref}) are the scaled boundary traction,
\begin{multline}\label{bdry_integral_curvi}
B({\bf u}_t,{\bf u}) = \int_{r^{(1)} = 0}^{r^{(1)} = 1} \int_{r^{(2)} = 0}^{r^{(2)} = 1} J|\nabla r^{(3)}|\frac{1}{J\left|\nabla r^{(3)}\right|} \left[{\bf u}_t^T\bar{A}_3\bar{\nabla} {\bf u}\right]_{r^{(3)}=0}^{r^{(3)}=1} \ dr^{(1)}dr^{(2)}\\
+ \int_{r^{(2)} = 0}^{r^{(2)} = 1} \int_{r^{(3)} = 0}^{r^{(3)} = 1} J|\nabla r^{(1)}|\frac{1}{J\left|\nabla r^{(1)}\right|}  \left[{\bf u}_t^T\bar{A}_1\bar{\nabla} {\bf u}\right]_{r^{(1)}=0}^{r^{(1)}=1}\ dr^{(2)}dr^{(3)} \\
+\int_{r^{(1)} = 0}^{r^{(1)} = 1} \int_{r^{(3)} = 0}^{r^{(3)} = 1} J|\nabla r^{(2)}|\frac{1}{J\left|\nabla r^{(2)}\right|}  \left[{\bf u}_t^T\bar{A}_2\bar{\nabla} {\bf u}\right]_{r^{(2)}=0}^{r^{(2)}=1} \ dr^{(1)}dr^{(3)} = \int_{\partial \Omega} {\bf u}_t^T({\bf n}\cdot\mathcal{T})\ dS.
\end{multline}
Here, ${\bf n}$ is the unit outward norm of the cuvilinear domain $\Omega$. It is obviously that $B({\bf u}_t, {\bf u}) = 0$ if ${\bf u}$ satifies the homogeneous Dirichlt boundary condition ${\bf u} = {\bf 0}$ or the free surface boundary condition ${\bf n}\cdot\mathcal{T} = {\bf 0}$. Finally, we rewrite (\ref{time_deri_curvi}) to
\begin{equation*}
\frac{1}{2}\frac{d}{dt} \left(||\sqrt{\rho}{\bf u}_t||_2^2 + S({\bf u},{\bf u})\right) = B({\bf u}_t,{\bf u}) + ({\bf u}_t,{\bf F})_2,
\end{equation*}
here, the term $||\sqrt{\rho}{\bf u}_t||_2^2$ represents the kinematic energy and the term $S({\bf u},{\bf u})$ is so called potental energy. If we have a homegeneous Dirichlet bounary condition or a free suface boundary condition, then
\begin{equation}\label{simple_time_deri_curvi}
\frac{1}{2}\frac{d}{dt} \left(||\sqrt{\rho}{\bf u}_t||_2^2 + S({\bf u},{\bf u})\right) =  ({\bf u}_t,{\bf F})_2,
\end{equation}
Integrating (\ref{simple_time_deri_curvi}) in time gives
\begin{equation*}
\frac{1}{2}\left(||\sqrt{\rho}{\bf u}_t||_2^2 + S({\bf u},{\bf u})\right)  = \frac{1}{2}\left(||\sqrt{\rho}{\bf u}_t||_2^2 + S({\bf u},{\bf u})\right)\Big|_{t = 0} + \int_{t = 0}^{t = T} ({\bf u}_t,{\bf F})_2 \ dt.
\end{equation*}
Therefore, the total energy of the solution of the elastic wave equation is conserved if the external force ${\bf F} = {\bf 0}$ for all time.


\section{The spatial discretization}
%We present the SBP operators, the semi-discrete equation, and the discretized boundary conditions and interface conditions. Also a semi-discrete energy estimate (if we do not write a fully discrete energy estimate).

In this section, we only describe the discretization for the curvilinear domain, and the Catesian domain can be obtained by simply setting the Cartesian coordinates as $x^{(k)}(r^{(k)}) = a^{(k)}r^{(k)} $ with $a^{(k)}$ being constants.
\subsection{SBP operators in $1$D}
Consider a uniform discretization of the domain $x\in[0,1]$ with the grids,
\[\wt
{{\bf x}} = [x_0,x_1,\cdots,x_n,x_{n+1}]^T,\ \  x_i = (i-1)h,\ \ i = 0,1,\cdots,n,n+1,\ \ h = 1/(n-1),\]
where $i = 1,n$ correspond to the grid points on the boundary, and $i = 0,n+1$ are ghost points outside the physical domain.
We also denote ${\bf x} = [x_1,x_2,\cdots,x_n]^T$ the grid that does not  contain the ghost points. We adopt the same notation as in \cite{?} by using the tilde symbol to indicate that ghost points are included. The  operator $D \approx \frac{\partial }{\partial x}$ is a first derivative SBP operator if 
\begin{equation}\label{first_sbp}
({\bf u}, D{\bf v})_h = -(D{\bf u},{\bf v})_h - u_1v_1 + u_nv_n,
\end{equation}
with a scalar product
\begin{equation}\label{inner_product}
({\bf u},{\bf v})_h = h\sum_{i = 1}^{n}\omega_iu_iv_i.
\end{equation}
Here, $0<\omega_i < \infty $ are the weights of scalar product. The SBP operator $D$ has a centered difference stencil at the grid points away from the boudnary and the corresponding weights $\omega_i = 1$. To satify the SBP identity (\ref{first_sbp}), the coefficients in $D$ are  modified at a few points near the boundary and the corresponding weights $\omega_i \neq 1$.

To discretize the elastic wave equation, we also need to approximate the second derivative with variable coefficient $(\gamma(x)u_x)_x$. Here, the known function $\gamma(x)>0$ describes the property of the material. There are two different fourth order accurate SBP operators for the approximation of $(\gamma(x)u_x)_x$. The first one $\wt{G}(\gamma){\bf u} \approx (\gamma(x)u_x)_x $, derived by Sj\"ogreen and Petersson \cite{?}, uses one ghost point outside each boundary, and satisfies the second derivative SBP identity,
\begin{equation}\label{sbp_2nd_1}
({\bf u}, \wt{G}(\gamma){\bf v})_h = -S_\gamma({\bf u},{\bf v})-u_1\gamma_1\wt{\bf b}_1{\bf v} + u_n\gamma_n\wt{\bf b}_n {\bf v}.
\end{equation}
Here, the bilinear form $S_\gamma(\cdot,\cdot)$ is symmetric and positive semi-definite, and does not use any ghost points. The operators $\wt{\bf b}_1$ and $\wt{\bf b}_n$ aprroximate the first derivative on the left and right boundaries, respectively. Using the left boundary as an example, we have 
\[
\wt{\bf b}_1 {\bf v} = \frac{1}{h}\sum_{i=0}^{4} \wt{d}_i v_i,
\]
as the fourth order accurate approximation of $u_x(x_1)$. We note that the notation $\wt{G}(\gamma){\bf v}$ implies that the operator $\wt{G}$ uses ${\bf v}$ on all grid points $\wt{{\bf x}}$, but $\wt{G}(\gamma){\bf v}$ only returns values on the grid ${\bf x}$ without ghost points. Therefore, when writing in matrix form, $\wt{G}$ is a non-square matrix of size $n$ by $n+2$.

The other SBP operator ${G}(\gamma){\bf u} \approx (\gamma(x)u_x)_x $ is developed by Mattsson \cite{?} without using any ghost points, and satisfies a similar SBP identity,
\begin{equation}\label{sbp_2nd_2}
({\bf u}, G(\gamma){\bf v})_h = -S_\gamma({\bf u},{\bf v})-u_1\gamma_1{\bf b}_1{\bf v} + u_n\gamma_n{\bf b}_n{\bf v}.
\end{equation}
Here, ${\bf b}_1$ and ${\bf b}_n$ are also finite difference operators for the first derivative at the boundaries, but are constructed to third order accurate,
\[
{\bf b}_1 {\bf v} = \frac{1}{h}\sum_{i=1}^{4} d_i v_i. 
\]
In this case, ${G}(\gamma)$ is square in matrix form. 


For the second derivative SBP operators $\wt{G}(\gamma)$ and $G(\gamma)$, both of them use a fourth order five points centered difference stencil to approximate $(\gamma u_x)_x$ for the interior points away from the boundaries. For the first and the last six grid points close to the boudaries, the operators $G(\gamma)$ and $\wt{G}(\gamma)$ use second order accurate one-sides difference stencils. They are designed to satisfy (\ref{sbp_2nd_2}) and (\ref{sbp_2nd_1}), respectively. In the following section, we use both of them to develop a multi-block finite difference discretization for the elastic wave equation. 

%For stucture and the form of the operators $\tilde{G}(\gamma)\tilde {\bf u}$ and $G(\gamma){\bf u}$, we refer the readers \cite{???} for detailed information.

\subsection{Semi-discretization of the elastic wave equation}
We consider the elastic wave equation in curvilinear coordinates 
\[\rho\frac{\partial^2 {\bf u}}{\partial t^2} = L{\bf u},\]
where
\begin{multline}\label{spatial_operator}
L{\bf u} = \frac{1}{J}\Big[\bar{\partial}_1(N^{11}\bar{\partial}_1{\bf u}) + \bar{\partial}_2(N^{22}\bar{\partial}_2{\bf u}) + \bar{\partial}_3(N^{33}\bar{\partial}_3{\bf u}) + \bar{\partial}_1(N^{12}\bar{\partial}_2{\bf u}) + \bar{\partial}_1(N^{13}\bar{\partial}_3{\bf u}) \\
+ \bar{\partial}_2(N^{21}\bar{\partial}_1{\bf u}) + \bar{\partial}_2(N^{23}\bar{\partial}_3{\bf u}) +\bar{\partial}_3(N^{31}\bar{\partial}_1{\bf u}) + \bar{\partial}_3(N^{32}\bar{\partial}_2{\bf u})\Big].
\end{multline}
The parameter space $[0,1]\times[0,1]\times[0,1]$ is discretized as $r_i^{(1)} = (i-1)h_1, i = 0,1,2,\cdots,n_1+1$, $r_i^{(2)} = (i-1)h_2, i = 0,1,2,\cdots,n_2+1$, and $r_i^{(3)} = (i-1)h_3, i = 0,1,2,\cdots,n_3+1$ with $h_1 = 1/(n_1-1), h_2 = 1/(n_2-1), h_3 = 1/(n_3-1)$, the ghost points are used to impose the boundary conditions and interface conditions.

The terms $\bar{\partial}_i(N^{ii}\bar{\partial}_i{\bf u}), i = 1,2,3$ in the spatial operator (\ref{spatial_operator}) are approximated by a fourth order second derivative SBP4 operator. The operators $D_i$ are used to approximate the $\bar{\partial}_i, i = 1,2,3$. The terms $\bar{\partial}_i(N^{ij}\bar{\partial}_j{\bf u}), i = 1,2,3, j = 1,2,3$ are approximated by using the first derivative operatoe $D$ twice. Then the spatial operator (\ref{spatial_operator}) is discretizes as
\begin{multline}
L_h{\bf u}_{i,j,k} = \frac{1}{J_{i,j,k}}\big[G_1(N_{11}){\bf u}_{i,j,k}+G_2(N_{22}){\bf u}_{i,j,k}+\tilde{G}_3(N_{33}){\bf u}_{i,j,k}+D_1(N_{12}D_2{\bf u}_{i,j,k})\\
+D_1(N_{13}D_3{\bf u}_{i,j,k})+D_2(N_{21}D_1{\bf u}_{i,j,k})+D_2(N_{23}D_3{\bf u}_{i,j,k})+D_3(N_{31}D_1{\bf u}_{i,j,k})\\
+D_3(N_{32}D_2{\bf u}_{i,j,k})\big],
\end{multline}
for $i = 1,2,\cdots,n_1$, $j = 1,2,\cdots,n_2$ and $k = 1,2,\cdots,n_3$.
 
\subsection{Physical boundary conditions}
We consier both homegeneous Dirichlet boundary condition and free surface bounary condition.

Here , clarify the process of update ghost points for the boundary forcing, in section 4, add the content for the 2d interpolation and restriction

\section{Grid refinement interface}
In this section, we partition the physical domian into two subdomains such that the discontinuity is aligned with subdomians' boundary $\Gamma$,
\begin{equation}\label{coarse_problem}
\rho^c\frac{\partial ^2 {\bf u}^c}{\partial t^2} = {\bf Lu}^c, \ \ \ \ \ {\bf x} \in \Omega_c,\ \ \ t>0,
\end{equation}
\begin{equation}\label{fine_problem}
\rho^f\frac{\partial ^2 {\bf u}^f}{\partial t^2} = {\bf Lu}^f, \ \ \ \ \ {\bf x} \in \Omega_f,\ \ \ t>0
\end{equation}
provided suitable initial and boundary conditions. We assume that $\Omega_f$ is on the top of $\Omega_c$ with $\Omega_c\cup\Omega_f = \Omega$ and $\Omega_c\cap\Omega_f = \Gamma$. The interface conditions are given to guarantee the continuity of the solutions and the continuity of the traction force,
\begin{equation}\label{continuity_sol}
{\bf u}_f = {\bf u}_c, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ {\bf x}\in \Gamma, \ \ \ t>0, 
\end{equation}
\begin{equation}\label{continuity_trac}
\mathcal{T}^f\cdot{\bf n}^f = -\mathcal{T}^c\cdot{\bf n}^c,  \ \ \ \ \ \ \  {\bf x}\in \Gamma, \ \ \ t>0.
\end{equation}
For simplicity, we consider periodic boundary condition in directions $1$ and $2$. Dirichlet boundary condition is given on the bottom surface (direction $3$) for $\Omega_c$ and traction force condition is assumed on the top surface (direction $3$) for $\Omega_f$.

\subsection{The fourth order SBP scheme}\label{sub_section_4_1}
We approximate the elastic wave equations (\ref{coarse_problem}) and (\ref{fine_problem}) by two different $4$th order SBP schemes. For spatial discretization, we use a Cartesian mesh with mesh size $h_i^c (h_i^f)$ in the coarse domain $\Omega_c$ (fine domain $\Omega_f$) for direction $i$ with $n_i^c = 1/h_i^c +1 (n_i^f = 1/h_i^f +1), i = 1,2,3$.

Suppose $(r^{c,(1)}_i, r^{c,(2)}_j, r^{c,(3)}_k), i = 1,2,\cdots,n_1^c, j = 1,2,\cdots,n_2^c,k=0,1,\cdots,n_3^c+1$ are grid points for doamin $\Omega_c$ and   $(r^{f,(1)}_i, r^{f,(2)}_j, r^{f,(3)}_k), i = 1,2,\cdots,n_1^f, j = 1,2,\cdots,n_2^f,k=1,\cdots,n_3^f+1$ are grid points for doamin $\Omega_f$. Note that we only consider the ghost points which are next to interface $\Gamma$ for the coarse domain. The ghost points which are next to the physical boundaries are used to approximate the physcial boudnary conditions. More precisely, in coarse domain $\Omega_c$, we have
\begin{multline}\label{coarse_scheme}
\rho_{i,j,k}^c ({\bf u}_{tt}^c)_{i,j,k} = \frac{1}{J_{i,j,k}^c}\Big[D_1^c(N_{11}^cD_1^c{\bf u}_{i,j,k}^c)+D_2^c(N_{22}^cD_2^c{\bf u}_{i,j,k}^c)+\tilde{\tilde{G}}_3^c(N_{33}^c){\bf u}_{i,j,k}^c\\
+D_1^c(N_{12}^cD_2^c{\bf u}_{i,j,k}^c)+D_1^c(N_{13}^cD_3^c{\bf u}_{i,j,k}^c)+D_2^c(N_{21}^cD_1^c{\bf u}_{i,j,k}^c)+D_2^c(N_{23}^cD_3^c{\bf u}_{i,j,k}^c)\\
+D_3^c(N_{31}^cD_1^c{\bf u}_{i,j,k}^c)+D_3^c(N_{32}^cD_2^c{\bf u}_{i,j,k}^c)\Big] \\
:= \tilde{\tilde{M}}_c(\mu,\lambda) {\bf{u}}^c_{i,j,k},
\end{multline}
for $ i = 1,2,\cdots,n_1^c, j = 1,2,\cdots,n_2^c, k = 1,2,\cdots,n_3^c$. For fine domian $\Omega_f$, we impose
\begin{multline}\label{fine_scheme_2}
\rho_{i,j,k}^f ({\bf u}_{tt}^f)_{i,j,k} =
 \frac{1}{J_{i,j,k}^f}\Big[D_1^f(N_{11}^fD_1^f{\bf u}_{i,j,k}^f)+D_2^f(N_{22}^fD_2^f{\bf u}_{i,j,k}^f)+\tilde{G}_3^f(N_{33}^f){\bf u}_{i,j,k}^f\\
+D_1^f(N_{12}^fD_2^f{\bf u}_{i,j,k}^f)+D_1^f(N_{13}^fD_3^f{\bf u}_{i,j,k}^f)
+D_2^f(N_{21}^fD_1^f{\bf u}_{i,j,k}^f)+D_2^f(N_{23}^fD_3^f{\bf u}_{i,j,k}^f)\\
+D_3^f(N_{31}^fD_1^f{\bf u}_{i,j,k}^f)
+D_3^f(N_{32}^fD_2^f{\bf u}_{i,j,k}^f)\Big], \\
:= \tilde{M}_f(\mu,\lambda) {\bf{u}}^f_{i,j,k},
\end{multline}
for $ i = 1,2,\cdots,n_1^f, j = 1,2,\cdots,n_2^f, k = 2,\cdots,n_3^f$ and
\begin{multline}\label{fine_scheme_1}
\rho_{i,j,k}^f ({\bf u}_{tt}^f)_{i,j,1} = \frac{1}{J_{i,j,1}^f}\Big[D_1^f(N_{11}^fD_1^f{\bf u}_{i,j,1}^f)+D_2^f(N_{22}^fD_2^f{\bf u}_{i,j,1}^f)+G_3^f(N_{33}^f){\bf u}_{i,j,1}^f\\
+D_1^f(N_{12}^fD_2^f{\bf u}_{i,j,1}^f)+D_1^f(N_{13}^fD_3^f{\bf u}_{i,j,1}^f)+D_2^f(N_{21}^fD_1^f{\bf u}_{i,j,1}^f)+D_2^f(N_{23}^fD_3^f{\bf u}_{i,j,1}^f)\\
+D_3^f(N_{31}^fD_1^f{\bf u}_{i,j,1}^f)+D_3^f(N_{32}^fD_2^f{\bf u}_{i,j,1}^f)+{\bm \eta}_{i,j}\Big]\\
 := M_f(\mu,\lambda){\bf u}^f_{i,j,1}+\frac{{\bm \eta}_{i,j}}{J^f_{i,j,1}},
\end{multline}
for $ i = 1,2,\cdots,n_1^f, j = 1,2,\cdots,n_2^f$ with
\begin{equation}\label{eta}
{\bm \eta}_{i,j} = \rho^f\big|_\Gamma\mathcal{P}\Big((\rho^c)^{-1}\tilde{\tilde{M}}_c(\mu,\lambda){\bf u}^c_{{\bf i}^c,{\bf j}^c,n_3^c}\Big)-M_f(\mu,\lambda){\bf u}^f_{i,j,1}.
\end{equation}
Here, we want to clear that the value of set ${\bf i}^c, {\bf j}^c$ depends on the order of the interpolation operator $\mathcal{P}$ and the layout of the coarse and fine grids, for example, consider $h_1^c = h_2^c, h_1^f = h_2^f$, then if $h^f = \frac{1}{2}h^c$ and $\mathcal{P}$ is fourth order,  we have ${\bf i}^c = \{(i+1)/2,i/2,(i-1)/2,(2i-2)/2\}$, ${\bf j}^c = \{(j+1)/2,j/2,(j-1)/2,(2j-2)/2\}$ if $i,j$ are even number and ${\bf i}^c = \{(i+1)/2\}$, ${\bf j}^c = \{(j+1)/2\}$ if $i,j$ are odd number. For the simplicity of analysis, we introduce a general notation for the schemes (\ref{fine_scheme_2}) and (\ref{fine_scheme_1}) in fine domain $\Omega_f$,
\begin{equation}\label{fine_scheme}
\rho^f_{i,j,k} ({\bf u}_{tt}^f)_{i,j,k} = \bar{M}_f(\mu,\lambda){\bf u}^f_{i,j,k} =  \left\{
\begin{aligned}
&\tilde{M}_f(\mu,\lambda) {\bf{u}}^f_{i,j,k}, \ \ k = 2,3,\cdots,n_3^f\\
&M_f(\mu,\lambda){\bf u}^f_{i,j,1}+{\bm \eta}_{i,j}/J^f_{i,j,1}
\end{aligned}
\right.
\end{equation}
for $i = 1,2,\cdots,n_f^1, j = 1,2,\cdots,n_f^2$.

For the grids in the fine domain $\Omega^f$  that are lying on the interface $\Gamma$, we impose the continuity of the solution,
\begin{equation}\label{data_continuous_curvi}
{\bf u}^f\big|_{\Gamma} = \mathcal{P}\big({\bf u}\big|_{\Gamma}\big).
\end{equation}
As for the ghost points which is on the direction 3 for the coarse domian, we impose the continuity of the traction force,
\begin{equation}\label{traction_continuous_curvi}
{\bf n}^c\cdot\mathcal{T}^c \big|_\Gamma = \mathcal{R}\left(-{\bf n}^f\cdot\mathcal{T}^f\big|_\Gamma - \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f\big|\nabla r_f^{(3)}\big|}\Big|_\Gamma\right).
\end{equation}

\subsection{Energy estimate}
%We derive an energy estimate, which tells us what interface conditions we shall impose. Also discuss boundary conditions. Be careful with the Jacobian.

%These two sections should not be too long. We shall cite previous works by Petersson and SjÃ¶green, and also Duru and Virta 2014. 

In this section, we investigate the energy estimate for the semi-discrete form of the SBP scheme in section \ref{sub_section_4_1}. Define the discrete scalar product for the interior of domain by
\begin{equation}\label{scalar_product_discrete_interior}
({\bf u}, {\bf v})_h = h_1h_2h_3\sum_{i=1}^{n_1}\sum_{j=1}^{n_2}\sum_{k=1}^{n_3}\omega_i^{(1)}\omega_j^{(2)}\omega_k^{(3)}J_{i,j,k}{\bf u}^{T}_{i,j,k}{\bf v}_{i,j,k},
\end{equation}
and the scalar product on the interface $\Gamma$,
\begin{equation}\label{scalar_product_discrete_interface}
({\bf u}, {\bf v})_{h,\Gamma} = h_1h_2\sum_{i=1}^{n_1}\sum_{j=1}^{n_2}\omega_i^{(1)}\omega_j^{(2)}J_{i,j,k}\big|\nabla r^{3}\big|{\bf u}_{i,j,k}^{T}{\bf v}_{i,j,k},
\end{equation}
where $k = 1$ for the interface of the fine domain $\Omega^f$ and $k = n_3^c$ for the interface of coarse domain $\Omega^c$ .

Multiplying (\ref{coarse_scheme}) by $h_1^ch_2^ch_3^c\omega_i^{(1)}\omega_j^{(2)}\omega_k^{(3)}J_{i,j,k}^c$ and summing over all grids, we have
\begin{equation}\label{coarse_simple}
({\bf u}_t^c, \rho^c{\bf u}_{tt}^c)_{h^c} = -S_{h^c}({\bf u}_t^c,{\bf u}^c) + B_{h^c}({\bf u}_t^c,{\bf u}^c),
\end{equation}
multiplying (\ref{fine_scheme_1}) by $h_1^fh_2^fh_3^f\omega_i^{(1)}\omega_j^{(2)}\omega_k^{(3)}J_{i,j,k}^f$ and summing over all grids, we obtain
\begin{multline}\label{fine_simple}
({\bf u}_t^f, \rho^f{\bf u}_{tt}^f)_{h^f} = -S_{h^f}({\bf u}_t^f,{\bf u}^f) + B_{h^f}({\bf u}_t^f,{\bf u}^f) \\
+h_3^f\omega_1^{(3)}h_1^fh_2^f\sum_{i=1}^{n_1^f}\sum_{j=1}^{n_2^f}\omega_i^{(1)}\omega_j^{(2)}({\bf u}_t^f)_{i,j,1}^{T}{\bm \eta}_{i,j},
\end{multline}
where  $S_h$ can be found in Appendix ?, and 
\begin{multline*}
B_h({\bf u}_t, {\bf u}) = \\
h_2h_3\sum_{j=1}^{n_2}\sum_{k=1}^{n_3}\omega_j^{(2)}\omega_j^{(3)}\big[({\bf u}_t)_{i,j,k}^{T}(N_{11}D_1{\bf u}_{i,j,k} + N_{12}D_2{\bf u}_{i,j,k} +N_{13}D_3{\bf u}_{i,j,k})\big]_{i=1}^{i=n_1}\\
+h_1h_3\sum_{i=1}^{n_1}\sum_{k=1}^{n_3}\omega_j^{(1)}\omega_j^{(3)}\big[({\bf u}_t)_{i,j,k}^{T}(N_{21}D_1{\bf u}_{i,j,k} + N_{22}D_2{\bf u}_{i,j,k} +N_{23}D_3{\bf u}_{i,j,k})\big]_{j=1}^{i=n_2}\\
+h_1h_2\sum_{i=1}^{n_1}\sum_{j=1}^{n_2}\omega_i^{(1)}\omega_j^{(2)}\big[({\bf u}_t)_{i,j,k}^{T}(N_{31}D_1{\bf u}_{i,j,k} + N_{32}D_2{\bf u}_{i,j,k} +N_{33}D_3{\bf u}_{i,j,k})\big]_{k=1}^{k=n_3}.
\end{multline*}
 We firstly impose homogeneous Dirichlet boundary condition,
\begin{equation*}
{\bf u}_{i,j,0} = {\bf 0},\ \ i = 1,2,\cdots,n_1^f, j = 1,2,\cdots,n_2^f 
\end{equation*}
to the bottom surface and a traction free surface boundary condition on the top surface,
\begin{equation*}
N_{31}^fD_1^f{\bf u}_{i,j,n_3^f}^f + N_{32}^fD_2^f{\bf u}_{i,j,n_3^f}^f +N_{33}^fD_3^f{\bf u}_{i,j,n_3^f}^f= {\bf 0}, 
\end{equation*}
with $i = 1,2,\cdots,n_1^f, j = 1,2,\cdots,n_2^f$. As for the direction $1$ and $2$, we assume a periodic boundary condition for simplicity. Then, we have
\begin{equation}\label{boundary_f}
B_{h_f} ({\bf u}_t^f,{\bf u}^f) = -h_1^fh_2^f\sum_{i = 1}^{n_1^f}\sum_{j=1}^{n_2^f}\omega_i^{(1)}\omega_j^{(2)}({\bf u}_t^f)^T_{i,j,1}\big(N_{31}^fD_1^f {\bf u}^f_{i,j,1}+ N_{32}^fD_2^f{\bf u}^f_{i,j,1}+N_{33}^fD_3^f{\bf u}^f_{i,j,1}\big),
\end{equation}
for $i = 1,2,\cdots, n_1^f, j = 1,2,\cdots,n_2^f$ and 
\begin{equation}\label{bounary_c}
B_{h_c} ({\bf u}_t^c,{\bf u}^c) = h_1^ch_2^c\sum_{i = 1}^{ n_1^c}\sum_{j=1}^{n_2^c}\omega_i^{(1)}\omega_j^{(2)}({\bf u}_t^f)^T_{i,j,n_3^c}\big(N_{31}^cD_1^c {\bf u}^c_{i,j,n_3^c}+ N_{32}^cD_2^c{\bf u}^c_{i,j,n_3^c}+N_{33}^cD_3^c{\bf u}^c_{i,j,n_3^c}\big),
\end{equation}
for $i = 1,2,\cdots,n_1^c, j = 1,2,\cdots,n_2^c$. Finally, we conclude a time derivative of the semi-discrete energy
\begin{multline}\label{semi_energy_1}
\frac{d}{dt}\big[({\bf u}_t^f,\rho^f {\bf u}_t^f)_{h^f} + S_{h^f}({\bf u}^f,{\bf u}^f_t) + ({\bf u}_t^c,\rho^c {\bf u}_t^c)_{h^c} + S_{h^c}({\bf u}^c,{\bf u}^c_t) \big]  = \\
2B_{h^f}({\bf u}_t^f,{\bf u}^f) + 2B_{h^c}({\bf u}_t^c,{\bf u}^c) + 2h_3^f\omega_1^{(3)}h_1^f h_2^f\sum_{i=1}^{n_1^f}\sum_{j=1}^{n_2^f}\omega_i^{(1)}\omega_j^{(2)}({\bf u}_t^f)^T_{i,j,1}{\bm \eta}_{i,j},
\end{multline}
plugging (\ref{boundary_f}) and (\ref{bounary_c}) into (\ref{semi_energy_1}) and combining the definition of the scalar product on the interface $\Gamma$ (\ref{scalar_product_discrete_interface}), we have
\begin{multline}\label{semi_energy_2}
\frac{d}{dt}\left[({\bf u}_t^f,\rho^f {\bf u}_t^f)_{h^f} + S_{h^f}({\bf u}^f,{\bf u}^f_t) + ({\bf u}_t^c,\rho^c {\bf u}_t^c)_{h^c} + S_{h^c}({\bf u}^c,{\bf u}^c_t) \right]  = \\
2\left(-{\bf u}_t^f,\frac{\hat{A}_3^f{\bf u}^f}{J^f|\nabla r_f^{(3)}|}\right)_{h_f,\Gamma} + 2\left({\bf u}_t^c,\frac{\hat{A}_3^c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\right)_{h_c,\Gamma} + 2\left({\bf u}_t^f,\frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\right)_{h_f,\Gamma} = \\
2\left({\bf u}_t^f,-\frac{\hat{A}_3^f{\bf u}^f}{J^f|\nabla r_f^{(3)}|} + \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\right)_{h_f,\Gamma} +  2\left({\bf u}_t^c,\frac{\hat{A}_3^c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\right)_{h_c,\Gamma} = \\
2\left(\mathcal{P}{\bf u}^c_t,-\frac{\hat{A}_3^f{\bf u}^f}{J^f|\nabla r_f^{(3)}|} + \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\right)_{h_f,\Gamma} + 2\left({\bf u}_t^c,\frac{\hat{A}_3^c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\right)_{h_c,\Gamma} = \\
2\left({\bf u}_t^c,\mathcal{R}\Big(-\frac{\hat{A}_3^f{\bf u}^f}{J^f|\nabla r_f^{(3)}|} + \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\Big)\right)_{h_c,\Gamma} + 2\left({\bf u}_t^c,\frac{\hat{A}_3^c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\right)_{h_c,\Gamma}.
\end{multline}
Here, to simplify the formula,  we have used the notation
\begin{equation}\label{hatA}
\hat{A}_3{\bf u}_{i,j,k} = N_{31}D_1{\bf u}_{i,j,k} + N_{32}D_2{\bf u}_{i,j,k} + N_{33}D_3{\bf u}_{i,j,k}.
\end{equation}
Sine we have the fact (\ref{traction_continuous_curvi}) in the cuvilinear coordinates, then combine with (\ref{bdry3_curvi}) arrives at
\begin{equation*}
\left(\frac{\hat{A}_3^c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\right)_{h_c,\Gamma} = \mathcal{R}\left(\frac{\hat{A}_3^f{\bf u}^f}{J^f|\nabla r_f^{(3)}|} - \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\right)_{h_c,\Gamma},
\end{equation*}
finally, we conclude that
\begin{equation*}
\frac{d}{dt}\left[({\bf u}_t^f,\rho^f {\bf u}_t^f)_{h^f} + S_{h^f}({\bf u}^f,{\bf u}^f_t) + ({\bf u}_t^c,\rho^c {\bf u}_t^c)_{h^c} + S_{h^c}({\bf u}^c,{\bf u}^c_t) \right]  = 0
\end{equation*}
without external force.

\section{The temporal discretization}
%We present the predictor-corrector discretization in time, and explain how the ghost points are updated. In addtion, we describle the iterative methods. Perhaps we shall also talk about CFL and the time steps. Maybe no fully-discrete energy analysis? That would be very messy. 
The equations are advance in time with an explicit fourth order accurate predictor-corrector time integration method. Like all explicit time stepping methods, there is a maximum time step not exceed CFL stabilitity limit.

In \cite{?}, it is proved that the time step constraint by CFL codition for the Newmark scheme 
\begin{equation*}
\frac{{\bf u}^{n+1}-2{\bf u}^n + {\bf u}^{n-1}}{\Delta_t^2} = {\bf L}_h{\bf u}^n + {\bf F}^n, \ \ \ n = 0,1,\cdots
\end{equation*}
 which is second order is
\begin{equation*}
\frac{\Delta_t^2}{h^2}\kappa_{\text{max}}\leq C_{\text{cfl}}^2.
\end{equation*}
Here, 
$\kappa_{\text{max}}$ is the maximum of the eigenvalue of the matrix 
\[T = \frac{1}{\rho}\left(\begin{array}{ccc}
Tr(N_{11}) &  Tr(N_{12})& Tr(N_{13})\\
Tr(N_{21}) & Tr(N_{22}) & Tr(N_{23})\\
Tr(N_{31}) & Tr(N_{32}) & Tr(N_{33})\end{array}\right). \]
Here, $Tr(N_{ij})$ represents the trace of the matrix $N_{ij},i,j = 1,2,3$. In this paper, we use the predictor-corrector strategy to obtain a fourth order time integrator. In \cite{?}, it shows that the fourth order scheme has a somewhat larger stability limit for the time step, but the way used to approximate eigenvalue is same. We use $C_{\text{cfl}} = $ in the numrical experiments in this paper.

\subsection{Time discretization with SBP scheme}
In the following, we give the detailed procedure about how we apply the fourth order time integrator to the problem (\ref{coarse_scheme}) -- (\ref{traction_continuous_curvi}). 

Let ${\bf u}^{n,c}$ and ${\bf u}^{n,f}$ denote the numerical approximations of ${\bf u}({\bf x},t_n), {\bf x}\in\Omega_c$ and ${\bf u}({\bf x},t_n), {\bf x}\in\Omega_f$ respectively. Here, $t_n = n\Delta t, n = 0,1,\cdots$ and $\Delta_t > 0$ is a constant time step. We present the fourth order time integrator with predictor and corrector in the Algorithm \ref{first_alg}.

\begin{breakablealgorithm}
	\caption{Fourth order accurate time steeping for the elastic wave equation with SBP discretization in space}\label{first_alg}
	Given initial conditions $\tilde{{\bf u}}^{0,c}, \tilde{{\bf u}}^{-1,c}$ and $\tilde{{\bf u}}^{0,f}, \tilde{{\bf u}}^{-1,f}$ that satisfies the discretized boundary conditions.
	
	\begin{itemize}
	\item  {Compute the predictor at the interior grid points for both fine and coarse domains
		\begin{equation*}
		   {\bf u}^{c,*,n+1}_{i,j,k} = 2{\bf u}^{c,n}_{i,j,k} - {\bf u}^{c,n-1}_{i,j,k} + \Delta_t^2\rho_c^{-1}\tilde{\tilde{M}}_c(\mu,\lambda) {\bf{u}}^c_{i,j,k}
		\end{equation*}
		\begin{equation*}
		{\bf u}^{f,*,n+1}_{i,j,k} = 2{\bf u}^{f,n}_{i,j,k} - {\bf u}^{f,n-1}_{i,j,k} + \Delta_t^2\rho_f^{-1}{\bar{M}}_f(\mu,\lambda) {\bf{u}}^f_{i,j,k}
		\end{equation*}
	   }
   \item {For the traction force boundary condition, assign the ghost point value ${\bf u}^{f,*,n+1}_{i,j,n^f_3+1}$ to satisfy
   	\begin{equation*}
   	N_{31}^fD_1{\bf u}^{f,*,n+1}_{i,j,n^f_3} + N_{32}^fD_2{\bf u}^{f,*,n+1}_{i,j,n^f_3} + N_{33}^fD_3{\bf u}^{f,*,n+1}_{i,j,n^f_3} = g(t_{n+1})
   	\end{equation*}
   }
   \item {For the Dirichlet boundary condition, assign the ghost point value ${\bf u}^{c,*,n+1}_{i,j,0}$ to satisfy
   	\begin{equation*}
   	\tilde{\tilde{M}}_c(\mu,\lambda) {\bf{u}}^{c,*,n+1}_{i,j,1} = 2\tilde{\tilde{M}}_c(\mu,\lambda) {\bf{u}}^{c,*,n}_{i,j,1} - 	\tilde{\tilde{M}}_c(\mu,\lambda) {\bf{u}}^{c,*,n-1}_{i,j,1}
   	\end{equation*}
   }
  \item{For continuity of solution on the interface $\Gamma$, assign the value ${\bf u}^{f,*,n+1}_{i,j,0}$ to satisfy
  	\begin{equation*}
  	{\bf u}^{f,*,n+1}\big|_{\Gamma} = \mathcal{P}\big({\bf u}^{c,*,n+1}\big|_{\Gamma}\big)
  	\end{equation*}
  }
  \item{For the continuity of traction force on the interface $\Gamma$, assign the ghost point value ${\bf u}^{c,*,n+1}_{i,j,n_3^c+1}$ to satisfy
  	\begin{equation}\label{traction_gamma_pre}
  	\left(\frac{\hat{A}_3^c{\bf u}^{c,*}}{J^c|\nabla r_c^{(3)}|}\right)_{h_c,\Gamma} = \mathcal{R}\left(\frac{\hat{A}_3^f{\bf u}^{f,*}}{J^f|\nabla r_f^{(3)}|} - \frac{h_3^f\omega_1^{(3)}{\bm \eta}^*}{J^f|\nabla r_f^{(3)}|}\right)_{h_c,\Gamma}
  	\end{equation}
  	with the definition of $\hat{A}_3$ in (\ref{hatA}) and ${\bm \eta}^*$ has a similar definition as in (\ref{eta}) with ${\bf u}^{*}$
  }
  \item{Evaluate the acceleration at all grids 
  	\begin{equation*}
  	\tilde{\bf v}^{c,n} = \frac{\tilde{\bf u}^{c,*,n+1}-2\tilde{\bf u}^{c,n}+\tilde{\bf u}^{c,n-1}}{\Delta^2_t}
  	\end{equation*}
  	\begin{equation*}
  	\tilde{\bf v}^{f,n} = \frac{\tilde{\bf u}^{f,*,n+1}-2\tilde{\bf u}^{f,n}+\tilde{\bf u}^{f,n-1}}{\Delta^2_t}
  	\end{equation*}
  }
  \item{Compute the corrector at the interior grid points
  	\begin{equation*}
  	{\bf u}^{c,n+1}_{i,j,k} = {\bf u}^{c,*,n+1}_{i,j,k} + \frac{\Delta_t^4}{12}\rho_c^{-1}\tilde{\tilde{M}}_c(\mu,\lambda) {\bf{u}}^{c,*,n}_{i,j,k}
  	\end{equation*}
  	\begin{equation*}
  		{\bf u}^{f,n+1}_{i,j,k} = {\bf u}^{f,*,n+1}_{i,j,k} + \frac{\Delta_t^4}{12}\rho_f^{-1}\bar{M}_f(\mu,\lambda) {\bf{u}}^{f,*,n}_{i,j,k}
  	\end{equation*}
  }
 \item {For the traction force boundary condition, assign the ghost point value ${\bf u}^{f,n+1}_{i,j,n_3^f+1}$ to satisfy
 		\begin{equation*}
 	N_{31}^fD_1{\bf u}^{f,n+1}_{i,j,n^f_3} + N_{32}^fD_2{\bf u}^{f,n+1}_{i,j,n^f_3} + N_{33}^fD_3{\bf u}^{f,n+1}_{i,j,n^f_3} = g(t_{n+1})
 	\end{equation*}	
 }
 \item {For the Dirichlet boundary condition, assign the ghost point value ${\bf u}^{c,n+1}_{i,j,0}$ to satify
 	\begin{equation*}
 	\tilde{\tilde{M}}(\mu,\lambda){\bf u}_{i,j,1}^{c,n+1} = \frac{\rho^c_{i,j,1}}{\Delta_t^2}\Big(d(t_{n+2})-2{\bf u}_{i,j,1}^{c,n+1}+{\bf u}_{i,j,1}^{c,n}\Big)
 	\end{equation*}
 }
 \item{For continuity of solution on the interface $\Gamma$, assign the value ${\bf u}^{f,n+1}_{i,j,0}$ to satisfy
	\begin{equation*}
	{\bf u}^{f,n+1}\big|_{\Gamma} = \mathcal{P}\big({\bf u}^{c,n+1}\big|_{\Gamma}\big)
	\end{equation*}
}
\item{For the continuity of traction force on the interface $\Gamma$, assign the ghost point value ${\bf u}^{c,n+1}_{i,j,n_3^c+1}$ to satisfy
	\begin{equation}\label{traction_gamma_corr}
	\left(\frac{\hat{A}_3^c{\bf u}^c}{J^c|\nabla r_c^{(3)}|}\right)_{h_c,\Gamma} = \mathcal{R}\left(\frac{\hat{A}_3^f{\bf u}^f}{J^f|\nabla r_f^{(3)}|} - \frac{h_3^f\omega_1^{(3)}{\bm \eta}}{J^f|\nabla r_f^{(3)}|}\right)_{h_c,\Gamma}
	\end{equation}
	with the definition of $\hat{A}_3$ in (\ref{hatA}) and ${\bm \eta}$ in (\ref{eta})
}
	\end{itemize}
\end{breakablealgorithm}
Here, we only give the steps to evolve the elatic wave equation with suitable initial and boundary condiitons and skip the detailed derivations of the fourth order predictor corrector time integator. One can refer to \cite{?} to get more details.

In the Algorithm \ref{first_alg}, we need to solve the equations come from the continuity of the traction force for the interface $\Gamma$ in both preditor step (\ref{traction_gamma_pre}) and corrector step (
\ref{traction_gamma_corr}). The structure of (\ref{traction_gamma_pre}) and (\ref{traction_gamma_corr}) are same, for simplicity, we only clarify how we solve (\ref{traction_gamma_pre}) in the predictor step.

Note that there are $n_1^cn_2^c$ unknowns in (\ref{traction_gamma_pre}) and $n_1^cn_2^c$ linear equations in (\ref{traction_gamma_pre}). Since it is very expensive to calculate the LU-factorization for a large problem in $3$D and there is no efficient ways to calculate the LU-factorization in a parallel machine, we instead using iterative methods to solve the linear system (\ref{traction_gamma_pre}). Specificly, we use three different iterative methods: block Jacobian iterative method, conjugate gradient iterative method, pre-conditioned conjugate gradient iterative method, to solve (\ref{traction_gamma_pre}). The details are given in Section \ref{iterative_section}.

\section{Numerical Experiments}
In this section, we conduct several numerical experiments. In Section \ref{manufactured_sol}, we compare the efficiency of iterative methods which are used to solve the interface condition system (\ref{traction_gamma_pre}) and (\ref{traction_gamma_corr}), note that the coefficient matrices in (\ref{traction_gamma_pre}) and (\ref{traction_gamma_corr}) are same and verify the order of the convergence of the proposed scheme (\ref{coarse_scheme})--(\ref{traction_continuous_curvi}). In Section \ref{gaussian_source}, we show that there is no reflection at the mesh refinment interfaces for the proposed scheme (\ref{coarse_scheme})--(\ref{traction_continuous_curvi}) with only a traction force on the top surface. Finally, the energy conservation property is shown in Section \ref{conserved_energy}.
\subsection{Method of manufactured solutions}\label{manufactured_sol}
We take the computation domain to be 
\begin{equation}\label{coarse_domain_manufactured}
 \left\{
\begin{aligned}
& x^{c,(1)} = 2\pi r^{(1)}\\
& x^{c,(2)} = 2\pi r^{(2)}\\
& x^{c,(3)} = r^{(3)}f_i\big(r^{(1)},r^{(2)}\big) + (1-r^{(3)})f_b\big(r^{(1)},r^{(2)}\big)
\end{aligned}
\right.
\end{equation}
for coarse domain $\Omega_c$. Here, $0\leq r^{(1)}, r^{(2)}, r^{(3)}\leq 1$, $f_i$ is the interface surface geometry,
\begin{equation}\label{iterface_geometry}
f_i\big(r^{(1)},r^{(2)}\big) = \pi+0.2\sin(4\pi r^{(1)})+0.2\cos(4\pi r^{(2)}),
\end{equation}
and 
$f_b$ is the bottom surface geometry,
\begin{equation}\label{bottom_geometry}
f_b\big(r^{(1)},r^{(2)}\big) = 0.2\exp\left(-\frac{(r^{(1)}-0.6)^2}{0.04}\right)+0.2\exp\left(-\frac{(r^{(2)}-0.6)^2}{0.04}\right).
\end{equation}
As for the fine domian $\Omega_f$, it is choose to be
\begin{equation}\label{fine_domain_manufactured}
\left\{
\begin{aligned}
& x^{f,(1)} = 2\pi r^{(1)}\\
& x^{f,(2)} = 2\pi r^{(2)}\\
& x^{f,(3)} = r^{(3)}f_t\big(r^{(1)},r^{(2)}\big) + (1-r^{(3)})f_i\big(r^{(1)},r^{(2)}\big),
\end{aligned}
\right.
\end{equation}
where $0\leq r^{(1)}, r^{(2)}, r^{(3)}\leq 1$, $f_t$ is the top surface geometry,
\begin{equation}\label{top_geometry}
f_t\big(r^{(1)},r^{(2)}\big) = 0.2\exp\left(-\frac{(r^{(1)}-0.5)^2}{0.04}\right)+0.2\exp\left(-\frac{(r^{(2)}-0.5)^2}{0.04}\right),
\end{equation}
and $f_i$ is the interface geometry which is given in (\ref{iterface_geometry}). Note that the subdomian 
$\Omega_f$ is on the top of $\Omega_c$. For both fine and coarse domians, let the density vary according to
\begin{equation}\label{density_function}
\rho(x^{(1)},x^{(2)},x^{(3)}) = 2 + \sin(x^{(1)}+0.3)\sin(x^{(2)}+0.3)\sin(x^{(3)}-0.2),
\end{equation}
and material parameters $\mu, \lambda$ satisfy
\begin{equation}\label{mu_function}
\mu(x^{(1)},x^{(2)},x^{(3)}) = 3 + \sin(3x^{(1)}+0.1)\sin(3x^{(2)}+0.1)\sin(x^{(3)}),
\end{equation}
and 
\begin{equation}\label{lambda_function}
\lambda(x^{(1)},x^{(2)},x^{(3)})  = 21+ \cos(x^{(1)}+0.1)\cos(x^{(2)}+0.1)\sin^2(3x^{(3)}),
\end{equation}
respectively. Besides, we impose a boundary forcing on the top surface and Dirichlet boundary conditions for the other boundaries. The internal forcing ${\bf F}$, top boundary forcing ${\bf g}$ and initial conditions are chosen such that ${\bf u} = (u_1,u_2,u_3)^T$ with
\begin{align*}
u_1 &= \cos(x^{(1)}+0.3)\sin(x^{(2)}+0.3)\sin(x^{(3)}+0.2)\cos(t^2),\\
u_2 &= \sin(x^{(1)}+0.3)\cos(x^{(2)}+0.3)\sin(x^{(3)}+0.2)\cos(t^2),\\
u_3 &= \sin(x^{(1)}+0.2)\sin(x^{(2)}+0.2)\cos(x^{(3)}+0.2)\sin(t).
\end{align*}
For example, for the boundary forcing on the top surface, we impose 
\begin{equation}\label{traction_force}
{\bf g} = (g_1,g_2,g_3)^T = \sum_{i=1}^3\left(\sum_{j = 1}^3 M_{ij}\frac{\partial{\bf u}}{\partial x^{(j)}}\right) n^{(i)},
\end{equation}
where, $n^{(i)}$ is the element of the unit outward normal ${\bf n} = (n^{(1)},n^{(2)},n^{(3)})$ for the top surface. 

\subsubsection{Iterative methods}\label{iterative_section}
In the proposed scheme (\ref{coarse_scheme})--(\ref{traction_continuous_curvi}), we need to solve a $3n_1^cn_2^c\times 3n_1^cn_2^c$ linear system at each time step twice for the continutiy of the traction force along the interface (\ref{traction_gamma_pre}) and (\ref{traction_gamma_corr}). Even ethough we can do LU factorization one time before the time loop start and reuse it at each time step, it is vergy expensive to do LU factorization for a large problem. Besides, consider solving real problems which are usually in large scale, we want to perform the computation on many processors on a parallel distributed memory machine, but it is not clear how to calculate the LU factorization of a matrix on many processors. 

In this paper, we propose three iterative methods: block Jacobian method, conjugate gradient method, preconditioned conjugate gradient method. We find that preconditioned conjugate gradient method is the most efficient one and conjugate gradient method needs most iteration numbers.

For the problem proposed in Section \ref{manufactured_sol}, the structure of coefficient matrix $H$ of the linear system (\ref{traction_continuous_curvi}) is shown in Figure \ref{?} which is determined by the interplation operator $\mathcal{P}$ and restriction operator $\mathcal{R}$. We choose the red parts of the coefficient matrix $H$ to be the block Jacobian matrix in block Jacobian iterative method and pre-conditioning matrix in conjugate gradient iterative method. 

Table \ref{?} shows the condition number of the original coefficient matrix, the block Jacobian matrix and the coefficient matrix after applying pre-conditioner. We observe that

Inside of each iterative method, we set a relative tolerance ..... to gurantee .....Table \ref{?} presents the number of iterations for conjugate gradient iterative method, block Jacobian iterative method and pre-conditioned conjugate gradient method. It shows that

\subsubsection{Verification of convergence rate}\label{convergence_study}
We now perform a convergence study for the proposed scheme (\ref{coarse_scheme})--(\ref{traction_continuous_curvi}). The $L_2$

\subsection{Gaussian source}\label{gaussian_source}
Show that no reflection at the mesh refinement interfaces. 

If the code is incorporated into SW4, it would be nice to solve a practical problem. 

\subsection{Energy conservation test}\label{conserved_energy}
We shall have an experiment for energy conservation. We also need to evaluate the iterative methods. These can be Experiment 3, or incoporated in the first two experiments.

\section{Conclusion}
\end{document}
